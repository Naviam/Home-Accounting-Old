(function(a){a.tools=a.tools||{version:"@VERSION"};a.tools.overlay={addEffect:function(d,c,a){b[d]=[c,a]},conf:{close:null,closeIcon:false,closeOnClick:true,closeOnEsc:true,closeSpeed:"fast",effect:"default",fixed:!a.browser.msie||a.browser.version>6,left:"center",load:false,mask:null,oneInstance:true,speed:"normal",target:null,top:"10%"}};var c=[],b={};a.tools.overlay.addEffect("default",function(b,e){var c=this.getConf(),d=a(window);if(!c.fixed){b.top+=d.scrollTop();b.left+=d.scrollLeft()}b.position=c.fixed?"fixed":"absolute";this.getOverlay().css(b).fadeIn(c.speed,e)},function(a){this.getOverlay().fadeOut(this.getConf().closeSpeed,a)});function d(i,e){var d=this,k=i.add(d),n=a(window),h,f,j,g=a.tools.expose&&(e.mask||e.expose),l=Math.random().toString().slice(10);if(g){if(typeof g=="string")g={color:g};g.closeOnClick=g.closeOnEsc=false}var m=e.target||i.attr("rel");f=m?a(m):null||i;if(!f.length)throw"Could not find Overlay: "+m;i&&i.index(f)==-1&&i.click(function(a){d.load(a);return a.preventDefault()});a.extend(d,{load:function(h){if(d.isOpened())return d;var o=b[e.effect];if(!o)throw'Overlay: cannot find effect : "'+e.effect+'"';e.oneInstance&&a.each(c,function(){this.close(h)});h=h||a.Event();h.type="onBeforeLoad";k.trigger(h);if(h.isDefaultPrevented())return d;j=true;g&&a(f).expose(g);var i=e.top,m=e.left,q=f.outerWidth({margin:true}),p=f.outerHeight({margin:true});if(typeof i=="string")i=i=="center"?Math.max((n.height()-p)/2,0):parseInt(i,10)/100*n.height();if(m=="center")m=Math.max((n.width()-q)/2,0);o[0].call(d,{top:i,left:m},function(){if(j){h.type="onLoad";k.trigger(h)}});if(g&&e.closeOnClick)a.mask.getMask().one("click",d.close);e.closeOnClick&&a(document).bind("click."+l,function(b){!a(b.target).parents(f).length&&d.close(b)});e.closeOnEsc&&a(document).bind("keydown."+l,function(a){a.keyCode==27&&d.close(a)});return d},close:function(c){if(!d.isOpened())return d;c=c||a.Event();c.type="onBeforeClose";k.trigger(c);if(c.isDefaultPrevented())return;j=false;b[e.effect][1].call(d,function(){c.type="onClose";k.trigger(c)});a(document).unbind("click."+l).unbind("keydown."+l);g&&a.mask.close();return d},getOverlay:function(){return f},getTrigger:function(){return i},getClosers:function(){return h},isOpened:function(){return j},getConf:function(){return e}});a.each("onBeforeLoad,onStart,onLoad,onBeforeClose,onClose".split(","),function(c,b){a.isFunction(e[b])&&a(d).bind(b,e[b]);d[b]=function(c){c&&a(d).bind(b,c);return d}});h=f.find(e.close||".close");if(!h.length&&!e.close||e.closeIcon){h=a('<a class="close"></a>');f.prepend(h)}h=f.find(e.close||".close");h.click(function(a){d.close(a)});e.load&&d.load()}a.fn.overlay=function(b){var e=this.data("overlay");if(e)return e;if(a.isFunction(b))b={onBeforeLoad:b};b=a.extend(true,{},a.tools.overlay.conf,b);this.each(function(){e=new d(a(this),b);c.push(e);a(this).data("overlay",e)});return b.api?e:this}})(jQuery)