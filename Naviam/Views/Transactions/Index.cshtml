@using Naviam.WebUI.Resources
@using Naviam.Data;
@{
    ViewBag.Title = SharedStrings.TransactionsTitle;
    Layout = "~/Views/Shared/_LayoutWithSidebars.cshtml";
    ViewBag.CombresScripts = "transactions";
}
@*intellisense support*@
@if (false)
{ 
    <script type="text/javascript" src="~/Scripts/jquery-1.6.2.js"></script> 
    <script type="text/javascript" src="~/Scripts/knockout-1.2.1.js"></script> 
    <script type="text/javascript" src="~/Scripts/knockout.mapping.js"></script> 
    <script type="text/javascript" src="~/Scripts/common.js"></script> 
}

<script type='text/javascript'>
    var getTransUrl = '@Url.Action("GetTransactions", "Transactions")';
    var delTransUrl = '@Url.Action("DeleteTransaction", "Transactions")';
    var updateTransUrl = '@Url.Action("UpdateTransaction", "Transactions")';
    
    var getCatUrl = '@Url.Action("GetCategories", "Transactions")';
    var getCatEditDlg = '@Url.Action("GetCategoriesEditDialog", "Transactions")';
    var updateCatUrl = '@Url.Action("UpdateCategory", "Transactions")';
    var delCatUrl = '@Url.Action("DeleteCategory", "Transactions")';

    var getExchangeDlg = '@Url.Action("GetExchangeDialog", "Transactions")';
    var getSplitDlg = '@Url.Action("GetSplitDialog", "Transactions")';

    var getAccountsUrl = '@Url.Action("GetAccounts", "Accounts")';
    var updateAccountUrl = '@Url.Action("UpdateAccount", "Accounts")';
    var addAccountAmountUrl = '@Url.Action("AddAccountAmount", "Accounts")';
    var deleteAccountUrl = '@Url.Action("DeleteAccount", "Accounts")';
    //var imageFilesPath = '@Url.Content("~/Content/images/dpicker/")';
    $(document).ready(function () {
        $(window).mousedown(function (event) {
            var check = $(event.target).parents('.tooltip').length;
            if (check === 0) $("#accounts_move").hide();
        });
        $('#upload_statement').html5_upload({ autostart: false, onFinish: function (event, total) {
            transModel.ReloadPage();
            accountsModel.Refresh();
        }
        });
    });
    function beg_upload_statement() {
        $('#upload_statement').trigger('html5_upload.start');
        return false;
    }
</script>

@section LeftColumn {
<script type="text/html" id="accountsTemplate">
    <li>
        <a href="#" data-bind="click: function(event) { $item.current($data); }, text: Name, css: {selected: $item.current() == $data}"></a>
        <a href="#" data-bind="click: function(event) { $item.edit($data); }, visible: $data.Id() != null">@SharedStrings.Edit</a>
        <a href="#" data-bind="click: function(event) { $item.delete($data); }, visible: $data.Id() != null">@SharedStrings.Delete</a>
        <span data-bind="amount: Balance, visible: $data.Id() != null"></span> <span data-bind="text: Currency, visible: $data.Id() != null"></span>
    </li>
</script>
<div id="accounts">
    <a href="#" data-bind="click: function(event) { addItem(); }">Add</a>
    <ul data-bind="template: {name:'accountsTemplate', foreach:items, templateOptions: { current: selectedItem, edit: editItem, delete: deleteItem } }" class='acc_menu'>
    </ul>
</div>
}

<script type="text/html" id="accounts_moveTemplate">
    <li>
        <a href="#" data-bind="click: function(event) { transModel.Transfer($data); }, text: Name"></a>
        <span data-bind="amount: Balance"></span> <span data-bind="text: Currency"></span>
    </li>
</script>
<div id="accounts_move" class='hidden tooltip' style="position: absolute;background-color:White;border:1px solid;width:200px;z-index:1">
    <ul data-bind="template: {name:'accounts_moveTemplate', foreach:move_items }">
    </ul>
</div>

<a href="#" onclick='return catModel.EditCategories();'>edit cats</a>
<script type="text/html" id="transRowTemplate">
    <tr data-bind="click: function(event) { transModel.GoToEdit(event, $data); }, css: {selected: transModel.selectedItem() == $data}">
        <td>
            <div style='width:75px'>
            <span data-bind="msDateTime: Date, visible: transModel.selectedItem() != $data" name="Date"></span>
            <input class="width100 enterastab" data-bind="visible: transModel.selectedItem() == $data, datepicker: Date, datepickerOptions: {format: dateFormat.masks['default'], lang: lang.culture, selectors: true, firstDay: lang.firstDay}" />
            @*<img data-bind="visible: transModel.selectedRow() == Id(), click: function(event) {transModel.showCalendar(event, $data);}" style="cursor:pointer;" alt="" src="@Url.Content("~/Content/images/dpicker/cal.gif")">*@
            </div>
        </td>
        <td style='width:275px'>
            <span data-bind="visible: transModel.selectedItem() != $data, text: Description"></span>
            <input class="width100 enterastab" data-bind="visible: transModel.selectedItem() == $data, value: Description" />
        </td>
        <td style='width:175px'>
            <span data-bind="visible: transModel.selectedItem() != $data, text: Category"></span>
            <div data-bind="visible: transModel.selectedItem() == $data" style='position:relative;'><input class="width100 enterastab" data-bind="category: Category" name="Category"/>
            <a href="#" onclick='return transModel.ShowCategories(this);' class='category_picker' tabindex='-1'></a></div>
        </td>
        <td style="width:120px;white-space:nowrap">
            @*<span data-bind="text: Amount, visible: transModel.selectedRow() != Id() || (transModel.currentItem != null && transModel.currentItem.Id() != null)"></span>
            <input class="width100" data-bind="visible: transModel.selectedRow() == Id() && transModel.currentItem.Id() == null, value: Amount" />*@
            <span data-bind="text: Direction() == 0 ? '-' : ''"></span>
            <span data-bind="amount: Amount, visible: transModel.selectedItem() != $data"></span>
            <input class="width100 enterastab" data-bind="visible: transModel.selectedItem() == $data, amount: Amount" name="Amount"/>        
            <span data-bind="text: Currency, visible: transModel.selectedItem() != $data"></span>
        </td>
        <td data-bind="visible: transModel.selectedItem() == $data && $data.Id() != null">
            <a href="#" data-bind="click: function(event) {transModel.ShowEdit(event, $data);}" tabindex='-1'>@SharedStrings.Edit</a>
            <a href="#" data-bind="click: function(event) {transModel.Delete($data);}" tabindex='-1'>@SharedStrings.Delete</a>
            <a href="#" data-bind="click: function(event) {transModel.ShowTransfer($data, event, 'trans');}" tabindex='-1'>Transfer</a>
            <a href="#" data-bind="click: function(event) {transModel.ShowTransfer($data, event, 'move');}" tabindex='-1'>Move</a>
            <a href="#" data-bind="click: function(event) {transModel.ShowSplit($data.Id);}" tabindex='-1'>@SharedStrings.Split</a>
        </td>
    </tr>
</script>

<script type="text/html" id="transPagingTemplate">
    <span>@DisplayNames.Page:</span>
    {{each(i) ko.utils.range(1, paging.PagesCount)}}
        <a href="#" data-bind="click: function() { paging.Page(i+1) }, css: { selected: i+1 == paging.Page() }" tabindex='-1'>
            ${ i + 1 }
        </a>
    {{/each}}
</script>
<script type="text/html" id="transHeadTemplate">
    <tr>
    {{each(i, head) headItems()}}
        <th data-bind="attr: {colspan: Columns}, text: Text()+(paging.SortField()==head.Field() ? (paging.SortDirection() == 0 ? ' ▲' : ' ▼') : ''), click: function() { Sort(head.Field()) }"></th>
    {{/each}}
    </tr>
</script>
<div>
    <div id="transGrid">
        @{var user = ViewBag.CurrentUser as UserProfile;}
        <a href="#" onclick='return transModel.ReloadPage();'>Refresh</a>
        <div data-bind="visible: accountsModel.selectedItem() != null && accountsModel.selectedItem().Id() != null">
            @using (Html.BeginForm("UploadStatement", "Attachments", new { @cid = user.CurrentCompany, @accId = 0 }, FormMethod.Post, new { @enctype = "multipart/form-data" }))
            {
                <input type="file" id='upload_statement' name='fileToUpload'/>
                <button onclick='beg_upload_statement();' type="button">@SharedStrings.Upload</button>
            }
            <a href="#" onclick='return transModel.Add();'>Add</a>
            <a href="#" onclick='return transModel.ShowExchange();'>Exchange</a>
        </div>
        <div class='grid'>
            <table>
                <thead data-bind='template: "transHeadTemplate"' ></thead>
                <tbody data-bind='template: { name: "transRowTemplate", foreach: items }'></tbody>
                <tfoot></tfoot>
            </table>
            <div data-bind='template: "transPagingTemplate"' ></div>
        </div>
    @*    <div class='hidden' id='edit_row' style='position:fixed;border:1px solid #000;'>
        <table width="100%">
        <tr>
        <td><input name="Description" /></td>
        </tr>
        </table>
        <a href="#" onclick='return transModel.ShowEditArea(this);'>Edit</a>
        <div class='edit_area hidden'">
            tstst
        </div>
    </div>*@    
    </div>
    <div class="overlaywoshadow" id="transDlg">
        <button data-bind="visible: ko.utils.unwrapObservable(Id) != null, click: function(event) {transModel.ShowSplit(Id)}">@SharedStrings.Split</button>
        <table>
        <tr>
            <td></td>
            <td>
                <label><input data-bind="checked: Direction" name="Direction" type="radio" value='0'/>@DisplayNames.Expense</label>
                <label><input data-bind="checked: Direction" name="Direction" type="radio" value='1'/>@DisplayNames.Income</label>
            </td>
        </tr>
        <tr>
            <td>@DisplayNames.IncludeInTax:</td>
            <td><input data-bind="checked: IncludeInTax" name="IncludeInTax" type="checkbox"/></td>
        </tr>
        <tr>
            <td>@DisplayNames.Merchant:</td>
            <td><input class="width100" data-bind="value: Merchant" name="Merchant"/></td>
        </tr>
        <tr>
            <td>@DisplayNames.Notes:</td>
            <td><textarea data-bind="value: Notes" name="Notes" rows='6' cols='30'></textarea></td>
        </tr>
        </table>
        <div>
            <button class='close' id='ok'>Ok</button>
            <button class='close' id='cancel'>@SharedStrings.Cancel</button>
        </div>     
    </div>
</div>

<script type="text/html" id="catTemplate">
    <li>
    <a href="#" data-bind="click: function(event) { catModel.AssignCategory($data); }, text: Name"></a>
        <ul>
        {{each(i, item) Subitems()}}
            <li data-bind="click: function(event) { catModel.AssignCategory(item); }">
            <a href="#" data-bind="text: Name"></a>
            </li>
        {{/each}}
        </ul>
    </li>
</script>
<div id="cat_menu" style='position:absolute'>
    <ul data-bind="template: {name:'catTemplate', foreach:items}" class='dropdown'>
    </ul>
</div>


<div id='account_edit' class='hidden'>
@*TODO: move to partial view*@
@using (Html.BeginForm("UpdateAccount", "Accounts", FormMethod.Post, new {id = "editAccountFrm" }))
{
<table>
@*    <tr>
        <td>Account Type:<select data-bind="options: accountsModel.currItems, optionsText: 'NameShort', optionsValue: 'Id', optionsCaption: 'Select an item...', value: CurrencyId", required="required" ></select></td>
    </tr>*@
    <tr>
        <td>Account Name:<input data-bind="value: Name" name="Name" required="required"/></td>
    </tr>
    <tr>
        <td>Fin Inst: <select required="required" data-bind="options: accountsModel.finInst, optionsText: 'Name', optionsValue: 'Id', optionsCaption: 'Select an item...', value: FinInstitutionId"></select></td>
    </tr>
    <tr data-bind="visible: FinInstitutionId">
        <td>Account Type: <select required="required" data-bind="options: accountsModel.getTypes(FinInstitutionId), optionsText: 'TypeName', optionsValue: 'Id', optionsCaption: 'Select an item...', value: TypeId"></select></td>
    </tr>
    <tr data-bind="visible: TypeId() == 2"> @*!!!Hardcoded (Bank card)*@
        <td>4 last digits:<input data-bind="value: CardNumber" name="CardNumber"/></td>
    </tr>
    <tr>
        <td>Currency: <select required="required" data-bind="options: accountsModel.currItems, optionsText: 'NameShort', optionsValue: 'Id', optionsCaption: 'Select an item...', value: CurrencyId"></select></td>
    </tr>
    <tr>
        <td>Initial Balance:<input data-bind="amount: InitialBalance, amountOptions: {allowZero: true}" name="InitialBalance" required="required"/></td>
    </tr>
    <tr>
        <td>Description:<textarea data-bind="value: Description" name="Description" rows='6' cols='30'></textarea></td>
    </tr>
</table>
<button type="button" data-bind="click: function(event) { Save(); }">Ok</button>
<button type="button" data-bind="click: function(event) { accountsModel.hideEdit(false); }">@SharedStrings.Cancel</button>
}
</div>

<div id='cat_edit_area' class="overlay"></div>
<div id='exchangeDialog' class="overlay"></div>
<div id='splitDialog' class="overlay"></div>

